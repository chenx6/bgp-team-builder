<!DOCTYPE html>
<html>
<meta charset="UTF-8">

<head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="row p-3">
            <ul class="nav navbar navbar-expand-lg navbar-light bg-light">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="#">Wasmdori</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Bestdori data generator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Band girl party team builder</a>
                </li>
            </ul>
        </div>
        <div id="user-input">
            <div class="row p-1">
                <div class="col-2">
                    <p>服务器</p>
                </div>
                <div class="col">
                    <select name="server" id="server" class="form-select">
                        <option value="en_EN">International</option>
                        <option value="zh_CN">简体中文</option>
                        <option value="zh_TW">繁体中文</option>
                        <option value="jp_JP">日本</option>
                    </select>
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <p>玩家资料</p>
                </div>
                <div class="col">
                    <textarea id="user_profile" class="form-control"></textarea>
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <label for="prop" class="col-form-label">加成属性</label>
                </div>
                <div class="col">
                    <select name="prop" id="prop" class="form-select">
                        <option value="happy">Happy</option>
                        <option value="pure">Pure</option>
                        <option value="cool">Cool</option>
                        <option value="powerful">Powerful</option>
                    </select>
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <label for="parameter" class="col-form-label">加成属性</label>
                </div>
                <div class="col">
                    <select name="parameter" id="parameter" class="form-select">
                        <option value="performance">Performance</option>
                        <option value="technique">Technique</option>
                        <option value="visual">Visual</option>
                    </select>
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <label for="characters" class="col-form-label">加成角色</label>
                </div>
                <div class="col">
                    <div id="characters-checkboxes" class="input-group">
                    </div>
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <label for="prop_bonus" class="col-form-label">属性加成大小</label>
                </div>
                <div class="col">
                    <input type="number" name="prop_bonus" id="prop_bonus" value="0.0" step="0.1" class="form-control">
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <label for="character_bonus" class="col-form-label">角色加成大小</label>
                </div>
                <div class="col">
                    <input type="number" name="character_bonus" id="character_bonus" value="0.0" step="0.1"
                        class="form-control">
                </div>
            </div>
            <div class="row p-1">
                <div class="col-2">
                    <label for="all_fit_bonus" class="col-form-label">所有匹配时加成大小</label>
                </div>
                <div class="col">
                    <input type="number" name="all_fit_bonus" id="all_fit_bonus" value="0.0" step="0.1"
                        class="form-control">
                </div>
            </div>
            <div class="row justify-content-center p-1">
                <div class="col align-self-end">
                    <button name="calc" id="calc-button" class="btn btn-primary">计算！</button>
                </div>
            </div>
        </div>
        <div class="row p-1">
            <div id="message"></div>
        </div>
        <div class="row p-1">
            <ul id="result-list" class="list-group list-group-horizontal p-1">
            </ul>
        </div>
    </div>
    <script type="module">
        import init, { gene_score } from './pkg/wasmdori.js';
        const calcScore = async () => {
            $("#message")
                .removeClass()
                .addClass("alert alert-info")
                .text("Building");
            await init();

            // Get user selected data
            let selected_prop = $("#prop").val();
            let selected_parameter = $("#parameter").val();
            let selected_characters = $(".character-checkbox")
                .serialize()
                .replaceAll("=on", "")
                .split("&")
                .map((v) => parseInt(v));
            let prop_bonus = parseFloat($("#prop_bonus").val());
            let character_bonus = parseFloat($("#character_bonus").val());
            let all_fit_bonus = parseFloat($("#all_fit_bonus").val());
            let user_profile = JSON.parse($("#user_profile").val());
            let event_bonus = {
                prop: selected_prop,
                parameter: selected_parameter,
                characters: selected_characters,
                prop_bonus: prop_bonus,
                character_bonus: character_bonus,
                all_fit_bonus: all_fit_bonus,
            };

            // Check data
            for (const k of Object.keys(event_bonus)) {
                let v = event_bonus[k];
                let e = false;
                if (v === null || v === undefined) {
                    e = true;
                }
                if (_.isArray(v) && (v.length != 5 || _.indexOf(v, null) != -1 || _.indexOf(v, undefined) != -1 || _.indexOf(v, NaN) != -1)) {
                    e = true;
                }
                if (e) {
                    $("#message").text(`The value of ${k} is wrong!`);
                    return;
                }
            }
            // Pass data to wasm for calculation
            let begin = Date.now();
            let result = gene_score(event_bonus, cards, user_profile, characters, bands);
            console.log("Used %dms", Date.now() - begin);

            // Generate and show result
            let resultHTML = '';
            for (const i of Object.keys(result)) {
                let cardId = result[i].card_id;
                let card = cards[cardId];
                let partNum = Math.floor(parseInt(cardId) / 50);
                let part = partNum.toString().padStart(5, '0');
                let url = `https://bestdori.com/assets/cn/thumb/chara/card${part}_rip/${card.resourceSetName}_after_training.png`;
                resultHTML += `<li class="list-group-item">
                    <div class="card">
                        <img src="${url}" class="card-img-top">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item text-truncate">${card.prefix[user_profile.server]}</li>
                            <li class="list-group-item text-truncate">${characters[card.characterId].characterName[user_profile.server]}</li>
                        </ul>
                    </div>
                    </li>`;
            }
            $("#result-list").html(resultHTML);
            $("#message")
                .removeClass()
                .addClass("alert alert-success")
                .text("Build success!");
        }
        document.getElementById("calc-button").addEventListener("click", calcScore);
    </script>
    <script lang="javascript">
        "use strict";
        let bands, cards, characters;
        let DISTRICT = 3;

        /*
         * Initlize data
         */
        async function initData() {
            bands = await unwrap_fetch("bands.json");
            cards = await unwrap_fetch("cards.json");
            characters = await unwrap_fetch("characters.json");
        }

        /*
         * Initlize character checkbox
         */
        function initCheckBox() {
            let result = '';
            for (const i of Object.keys(characters)) {
                let characterName = characters[i].characterName[DISTRICT];
                if (characterName === null) {
                    continue;
                }
                result += `<div class="p-1">
                    <label for="${i}" class="form-check-label">${characterName}</label>
                    <input type="checkbox" name="${i}" class="character-checkbox form-check-input">
                </div>`
            }
            $("#characters-checkboxes").html(result);
        }

        async function unwrap_fetch(url) {
            let response = await fetch(url);
            return await response.json();
        }

        /**
         * TODO Translate data
         */
        function tr(origin) {

        }

        /*
         * Change district
         */
        function changeDistrict() {
            let v = $("#server").val();
            switch (v) {
                case "jp_JP":
                    DISTRICT = 0;
                    break;
                case "en_EN":
                    DISTRICT = 1;
                    break;
                case "zh_TW":
                    DISTRICT = 2;
                    break;
                case "zh_CN":
                    DISTRICT = 3;
                    break;
                default:
                    break;
            }
        }

        initData().then(() => { initCheckBox() });
        $("#server").change(changeDistrict);
    </script>
</body>

</html>